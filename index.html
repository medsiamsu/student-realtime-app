<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üìä ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° Realtime</title>

<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{font-family:'Sarabun',sans-serif;background:#e0e7ff;margin:0;display:flex;justify-content:center}
.container{background:#fff;margin:20px;padding:20px;border-radius:16px;width:100%;max-width:950px;text-align:center}
.hidden{display:none}
button{padding:10px 18px;border-radius:8px;border:0;color:#fff;margin:5px;cursor:pointer}
.btn-primary{background:#2563eb}.btn-green{background:#10b981}.btn-purple{background:#8b5cf6}
input,select{padding:10px;border-radius:8px;border:1px solid #ccc;width:220px;margin-bottom:8px}
.choices button{width:55px;height:55px;border-radius:50%;background:#f1f5f9;color:#000;border:2px solid #cbd5e1}
.choices button.selected{background:#2563eb;color:#fff}
.chart-box{margin-top:25px;padding:15px;border:1px solid #e5e7eb;border-radius:12px}
.btn-red{background:#ef4444}
</style>
</head>

<body>
<div class="container">

<!-- HOME -->
<div id="homePage">
  <h1>üìò ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° Realtime</h1>
  <h3>‡∏£‡∏≠‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span id="currentRoundLabel"></span></h3>
  <button class="btn-green" id="toStudent">üéì ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</button>
  <button class="btn-purple" id="toTeacher">üë©‚Äçüè´ ‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå</button>
</div>

<!-- STUDENT -->
<div id="studentPage" class="hidden">
  <h2>üéì ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h2>
  <p>‡∏£‡∏≠‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <b id="roundStudent"></b></p>
  <input id="room" placeholder="‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"><br>
  <input id="student_id" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤"><br>

  <div class="choices">
    <button data-c="A">A</button>
    <button data-c="B">B</button>
    <button data-c="C">C</button>
    <button data-c="D">D</button>
    <button data-c="E">E</button>
  </div><br>

  <button class="btn-green" id="submitBtn">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
  <button class="btn-primary" id="backHome1">üè† ‡∏Å‡∏•‡∏±‡∏ö</button>
  <div id="status"></div>
</div>

<!-- TEACHER -->
<div id="teacherPage" class="hidden">
  <h2>üë©‚Äçüè´ ‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå</h2>
  <p>‡∏£‡∏≠‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <b id="roundTeacher"></b></p>
  <button class="btn-green" id="newRoundBtn">‚ûï ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà</button>
  <button class="btn-red" id="resetSystemBtn">üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
  <button class="btn-primary" id="exportExcelBtn">üì• Export Excel</button>

  <br><br>
  <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡∏π‡∏£‡∏≠‡∏ö:</label>
  <select id="roundFilter">
    <option value="all">‡∏ó‡∏∏‡∏Å‡∏£‡∏≠‡∏ö</option>
  </select>

  <div id="chartsContainer"></div>
  <button class="btn-primary" id="backHome2">üè† ‡∏Å‡∏•‡∏±‡∏ö</button>
</div>

</div>

<script>
document.addEventListener("DOMContentLoaded",()=>{

const $ = id => document.getElementById(id);

// DOM
const homePage=$("homePage"), studentPage=$("studentPage"), teacherPage=$("teacherPage");
const toStudent=$("toStudent"), toTeacher=$("toTeacher");
const backHome1=$("backHome1"), backHome2=$("backHome2");
const submitBtn=$("submitBtn"), newRoundBtn=$("newRoundBtn"), exportExcelBtn=$("exportExcelBtn");
const room=$("room"), student_id=$("student_id"), status=$("status");
const currentRoundLabel=$("currentRoundLabel"), roundStudent=$("roundStudent"), roundTeacher=$("roundTeacher");
const chartsContainer=$("chartsContainer"), roundFilter=$("roundFilter");

// Supabase
const supabase = window.supabase.createClient(
  "https://nbhxeojflxxmowiaogjh.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5iaHhlb2pmbHh4bW93aWFvZ2poIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4MzQ0ODAsImV4cCI6MjA4MzQxMDQ4MH0.eOX4LtcSzetMbOFTKaH8ElWJx0l8V2SLFgeb0a3IVWw"
);

// State
let currentRound=1, roundOpen=true, selected=null;
let chartsByRound={}, roundCounts={};
let roundChannel=null, attendanceChannel=null;
let realtimeActive=false;
let chartLocked = localStorage.getItem("chartLocked") === "true";

// ---------- Realtime ----------
function subscribeRealtime(){
  if(realtimeActive) return;
  realtimeActive=true;

  roundChannel = supabase.channel("round-rt")
    .on("postgres_changes",{event:"UPDATE",schema:"public",table:"round_control"}, syncRound)
    .subscribe();

  attendanceChannel = supabase.channel("attendance-rt")
    .on("postgres_changes",{event:"*",schema:"public",table:"attendance"}, initialLoad)
    .subscribe();
}

// ---------- Navigation ----------
toStudent.onclick=async()=>{
  homePage.classList.add("hidden");
  studentPage.classList.remove("hidden");
  subscribeRealtime();
  await syncRound();
};

toTeacher.onclick=async()=>{
  if(prompt("‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå")==="2568"){
    homePage.classList.add("hidden");
    teacherPage.classList.remove("hidden");
    subscribeRealtime();
    await syncRound();
    await initialLoad();
  }
};

backHome1.onclick=backHome2.onclick=()=>location.reload();

// ---------- Choice ----------
document.querySelectorAll(".choices button").forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll(".choices button").forEach(x=>x.classList.remove("selected"));
    b.classList.add("selected");
    selected=b.dataset.c;
  };
});

// ---------- Round ----------
async function syncRound(){
  const {data}=await supabase.from("round_control").select("*").eq("id",1).single();
  if(!data) return;
  currentRound=data.current_round;
  roundOpen=data.is_open;
  currentRoundLabel.innerText=roundStudent.innerText=roundTeacher.innerText=currentRound;
}
syncRound();

// ---------- Student ----------
submitBtn.onclick=async()=>{
  await syncRound();
  if(!roundOpen) return alert("‚ùå ‡∏£‡∏≠‡∏ö‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß");
  if(!room.value||!student_id.value||!selected) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

  const {data:ex}=await supabase
    .from("attendance")
    .select("id")
    .eq("student_id",student_id.value)
    .eq("round_id",currentRound)
    .maybeSingle();

  if(ex){ status.innerText="‚ö†Ô∏è ‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß"; return; }

  const {error}=await supabase.from("attendance").insert({
    room:room.value,
    student_id:student_id.value,
    round_id:currentRound,
    question_number:1,
    choice:selected
  });

  status.innerText = error ? "‚ùå ‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" : "‚úÖ ‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß";
};

// ---------- Teacher ----------
async function initialLoad(){
  if (chartLocked) {
    console.log("‚õî ‡∏Å‡∏£‡∏≤‡∏ü‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Å ‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô");
    return;
  }

  chartsContainer.innerHTML="";
  chartsByRound={};
  roundCounts={};
  roundFilter.innerHTML=`<option value="all">‡∏ó‡∏∏‡∏Å‡∏£‡∏≠‡∏ö</option>`;

  const {data}=await supabase
    .from("attendance")
    .select("*")
    .order("round_id");

  if(!data) return;

  data.forEach(r=>{
    if(!roundCounts[r.round_id]){
      roundCounts[r.round_id]={A:0,B:0,C:0,D:0,E:0};
      roundFilter.innerHTML+=
        `<option value="${r.round_id}">‡∏£‡∏≠‡∏ö ${r.round_id}</option>`;
    }
    roundCounts[r.round_id][r.choice]++;
  });

  applyRoundFilter();
}

function applyRoundFilter(){
  chartsContainer.innerHTML="";
  const r=roundFilter.value;

  if(r==="all"){
    Object.keys(roundCounts).forEach(x=>renderChart(x,roundCounts[x]));
  }else if(roundCounts[r]){
    renderChart(r,roundCounts[r]);
  }
}

roundFilter.onchange=applyRoundFilter;

function renderChart(round,counts){
  const box=document.createElement("div");
  box.className="chart-box";
  box.innerHTML=`<h4>‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà ${round}</h4>`;
  const c=document.createElement("canvas");
  box.appendChild(c);
  chartsContainer.appendChild(box);

  chartsByRound[round]=new Chart(c,{
    type:"pie",
    data:{labels:Object.keys(counts),datasets:[{data:Object.values(counts)}]}
  });
}

// ---------- Buttons ----------
newRoundBtn.onclick=async()=>{
  await supabase.from("round_control")
    .update({current_round:currentRound+1,is_open:true})
    .eq("id",1);
  syncRound();
};

$("resetSystemBtn").onclick = async () => {

  if(!confirm("‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏∞‡∏ö‡∏ö + ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 1 ?")) return;

  // üîí ‡∏•‡πá‡∏≠‡∏Å‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ö‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£
  localStorage.setItem("chartLocked", "true");
  chartLocked = true;

  // üß® ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡∏Å‡∏£‡∏≤‡∏ü
  Object.values(chartsByRound).forEach(ch=>{
    if(ch) ch.destroy();
  });

  // üßº ‡∏•‡πâ‡∏≤‡∏á UI
  chartsByRound = {};
  roundCounts = {};
  chartsContainer.innerHTML="";
  roundFilter.innerHTML = `<option value="all">‡∏ó‡∏∏‡∏Å‡∏£‡∏≠‡∏ö</option>`;

  // üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ó‡∏£‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ 1
  await supabase
    .from("round_control")
    .update({ current_round: 1, is_open: true })
    .eq("id",1);

  await syncRound();

  alert("‚úÖ ‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏≤‡∏ü‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏≠‡∏µ‡∏Å");
};


exportExcelBtn.onclick=async()=>{
  const {data}=await supabase.from("attendance").select("*");
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(data),"data");
  XLSX.writeFile(wb,"attendance.xlsx");
};

});
</script>
</body>
</html>
