<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üìä ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° Realtime</title>

<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  font-family:'Sarabun',sans-serif;
  background:#e0e7ff;
  margin:0;
  display:flex;
  justify-content:center;
}
.container{
  background:#fff;
  margin:20px;
  padding:20px;
  border-radius:16px;
  width:100%;
  max-width:950px;
  text-align:center;
}
.hidden{display:none}
button{
  padding:10px 18px;
  border-radius:8px;
  border:0;
  color:#fff;
  margin:5px;
  cursor:pointer
}
.btn-primary{background:#2563eb}
.btn-green{background:#10b981}
.btn-purple{background:#8b5cf6}
.btn-red{background:#ef4444}
button:disabled{opacity:.5;cursor:not-allowed}

input,select{
  padding:10px;
  border-radius:8px;
  border:1px solid #ccc;
  width:220px;
  margin-bottom:8px;
}

.choices button{
  width:55px;height:55px;border-radius:50%;
  background:#f1f5f9;color:#000;
  border:2px solid #cbd5e1;
}
.choices button.selected{
  background:#2563eb;color:#fff;
}

.responses-list{
  margin-top:10px;
  border:1px solid #ddd;
  border-radius:10px;
  max-height:300px;
  overflow:auto;
  text-align:left;
}
.response-item{
  display:flex;
  justify-content:space-between;
  padding:6px 10px;
  border-bottom:1px solid #eee;
}

.chart-box{
  margin-top:30px;
  padding:15px;
  border:1px solid #e5e7eb;
  border-radius:12px;
}

#status{
  margin-top:12px;
  font-weight:600;
  font-size:18px;
}

</style>
</head>
<body>

<div class="container">

<!-- HOME -->
<div id="homePage">
  <h1>üìò ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° Realtime</h1>
  <h3>‡∏£‡∏≠‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span id="currentRoundLabel"></span></h3>
  <button class="btn-green" id="toStudent">üéì ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</button>
  <button class="btn-purple" id="toTeacher">üë©‚Äçüè´ ‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå</button>
</div>

<!-- STUDENT -->
<div id="studentPage" class="hidden">
  <h2>üéì ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h2>
  <p>‡∏£‡∏≠‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <b id="roundStudent"></b></p>

  <input id="room" placeholder="‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"><br>
  <input id="student_id" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤"><br>

  <div class="choices">
    <button data-c="A">A</button>
    <button data-c="B">B</button>
    <button data-c="C">C</button>
    <button data-c="D">D</button>
    <button data-c="E">E</button>
  </div><br>

  <button class="btn-green" id="submitBtn">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
  <button class="btn-primary" id="backHome1">üè† ‡∏Å‡∏•‡∏±‡∏ö</button>

  <div id="status"></div>
</div>

<!-- TEACHER -->
<div id="teacherPage" class="hidden">
  <h2>üë©‚Äçüè´ ‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå</h2>
  <p>‡∏£‡∏≠‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <b id="roundTeacher"></b></p>

  <button class="btn-red" id="newRoundBtn">‚ûï ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà</button>
  <button class="btn-red" id="resetAllBtn">‚ôªÔ∏è ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
  <button class="btn-green" id="exportExcelBtn">üì• Export Excel</button>

  <br><br>
  <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡∏π‡∏£‡∏≠‡∏ö:</label>
  <select id="roundFilter">
    <option value="all">‡∏ó‡∏∏‡∏Å‡∏£‡∏≠‡∏ö</option>
  </select>

  <div id="chartsContainer"></div>
  <div id="responsesList" class="responses-list"></div>

  <button class="btn-primary" id="backHome2">üè† ‡∏Å‡∏•‡∏±‡∏ö</button>
</div>

</div>

<script>
// ================= Supabase =================
const supabase = window.supabase.createClient(
  "https://dmubpvmqslemshqlbcsy.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtdWJwdm1xc2xlbXNocWxiY3N5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MzM0NDcsImV4cCI6MjA4MTQwOTQ0N30.yS9xv2SA8ofmlTt4vr5oBsc5pQ8aOyyzltaLmJ2jSNw"
);

// ================= State =================
let currentRound = 1;
let roundOpen = true;
let selected = null;

const chartsByRound = {};
const roundCounts = {};

// ================= Sync Round =================
async function syncRound(){
  const { data } = await supabase
    .from("round_control")
    .select("current_round,is_open")
    .eq("id",1)
    .single();

  currentRound = data.current_round;
  roundOpen = data.is_open;
  updateRoundUI();
}

function updateRoundUI(){
  currentRoundLabel.innerText = currentRound;
  roundStudent.innerText = currentRound;
  roundTeacher.innerText = currentRound;
  submitBtn.disabled = !roundOpen;
}

syncRound();

supabase.channel("round-rt")
.on("postgres_changes",
 { event:"UPDATE", schema:"public", table:"round_control" },
 payload=>{
   currentRound = payload.new.current_round;
   roundOpen = payload.new.is_open;
   updateRoundUI();
 })
.subscribe();

// ================= NAV =================
toStudent.onclick=()=>{
  homePage.classList.add("hidden");
  studentPage.classList.remove("hidden");
};
toTeacher.onclick=()=>{
  if(prompt("‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå")==="2568"){
    homePage.classList.add("hidden");
    teacherPage.classList.remove("hidden");
    initialLoad();
  }
};
backHome1.onclick=()=>location.reload();
backHome2.onclick=()=>location.reload();

// ================= Choices =================
document.querySelectorAll(".choices button").forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll(".choices button").forEach(b=>b.classList.remove("selected"));
    btn.classList.add("selected");
    selected=btn.dataset.c;
  };
});

// ================= DOM =================
const status = document.getElementById("status");

// ================= Submit =================
submitBtn.onclick = async () => {
  if (!room.value || !student_id.value || !selected) {
    alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
    return;
  }

  const { error } = await supabase.from("attendance").insert({
    room: room.value,
    student_id: student_id.value,
    round_id: currentRound,
    question_number: 1,
    choice: selected
  });

  if (error) {
    console.error(error);
    status.innerText = "‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡∏™‡πà‡∏á‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß";
    status.style.color = "red";
  } else {
    status.innerText = "‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß";
    status.style.color = "green";
    submitBtn.disabled = true;   // üî• ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
  }
};

// ================= Initial Load =================
async function initialLoad(){
  const { data } = await supabase
    .from("attendance")
    .select("round_id,choice,student_id,room")
    .order("round_id");

  responsesList.innerHTML = "";
  roundFilter.innerHTML = `<option value="all">‡∏ó‡∏∏‡∏Å‡∏£‡∏≠‡∏ö</option>`;

  data.forEach(r=>{
    if(!roundCounts[r.round_id]){
      roundCounts[r.round_id]={A:0,B:0,C:0,D:0,E:0};
      roundFilter.innerHTML+=`<option value="${r.round_id}">‡∏£‡∏≠‡∏ö ${r.round_id}</option>`;
    }
    roundCounts[r.round_id][r.choice]++;

    responsesList.innerHTML+=`
      <div class="response-item">
        <span>${r.student_id} (${r.room})</span>
        <b>${r.choice}</b>
        <span>‡∏£‡∏≠‡∏ö ${r.round_id}</span>
      </div>`;
  });

  Object.keys(roundCounts).forEach(r=>{
    renderChart(r, roundCounts[r]);
  });
}

// ================= Chart =================
function renderChart(round, counts){
  if(chartsByRound[round]){
    chartsByRound[round].data.datasets[0].data = Object.values(counts);
    chartsByRound[round].update();
    return;
  }

  const box=document.createElement("div");
  box.className="chart-box";
  box.dataset.round=round;
  box.innerHTML=`<h4>‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà ${round}</h4>`;

  const canvas=document.createElement("canvas");
  box.appendChild(canvas);
  chartsContainer.appendChild(box);

  chartsByRound[round]=new Chart(canvas,{
    type:"pie",
    data:{
      labels:Object.keys(counts),
      datasets:[{data:Object.values(counts)}]
    }
  });
}

// ================= Filter =================
roundFilter.onchange=()=>{
  document.querySelectorAll(".chart-box").forEach(b=>{
    b.style.display =
      roundFilter.value==="all" || b.dataset.round===roundFilter.value
      ? "block" : "none";
  });
};

// ================= Realtime INSERT =================
supabase.channel("attendance-rt")
.on("postgres_changes",
 { event:"INSERT", schema:"public", table:"attendance" },
 payload=>{
   const r = payload.new;

   if(!roundCounts[r.round_id]){
     roundCounts[r.round_id]={A:0,B:0,C:0,D:0,E:0};
     roundFilter.innerHTML+=`<option value="${r.round_id}">‡∏£‡∏≠‡∏ö ${r.round_id}</option>`;
   }

   roundCounts[r.round_id][r.choice]++;
   renderChart(r.round_id, roundCounts[r.round_id]);

   responsesList.insertAdjacentHTML("afterbegin",`
     <div class="response-item">
       <span>${r.student_id} (${r.room})</span>
       <b>${r.choice}</b>
       <span>‡∏£‡∏≠‡∏ö ${r.round_id}</span>
     </div>
   `);
 }).subscribe();

// ================= Reset All =================
resetAllBtn.onclick = async () => {
  if (!confirm("‚ö†Ô∏è ‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;

  await supabase.rpc("truncate_attendance");

  await supabase
    .from("round_control")
    .update({ current_round: 1, is_open: true })
    .eq("id", 1);

  Object.values(chartsByRound).forEach(c=>c.destroy());
  Object.keys(chartsByRound).forEach(k=>delete chartsByRound[k]);
  Object.keys(roundCounts).forEach(k=>delete roundCounts[k]);

  chartsContainer.innerHTML="";
  responsesList.innerHTML="";
  roundFilter.innerHTML=`<option value="all">‡∏ó‡∏∏‡∏Å‡∏£‡∏≠‡∏ö</option>`;

  await syncRound();

  alert("‚úÖ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
};

// ================= New Round =================
newRoundBtn.onclick=async()=>{
  await supabase.from("round_control")
    .update({current_round:currentRound+1,is_open:true})
    .eq("id",1);

  await syncRound();
};

// ================= Export Excel =================
exportExcelBtn.onclick=async()=>{
  const { data } = await supabase.from("attendance").select("*");
  const wb=XLSX.utils.book_new();
  const grouped={};

  data.forEach(r=>{
    if(!grouped[r.round_id]) grouped[r.round_id]=[];
    grouped[r.round_id].push(r);
  });

  Object.keys(grouped).forEach(r=>{
    XLSX.utils.book_append_sheet(
      wb,
      XLSX.utils.json_to_sheet(grouped[r]),
      "Round_"+r
    );
  });

  XLSX.writeFile(wb,"attendance_by_round.xlsx");
};
</script>
</body>
</html>
