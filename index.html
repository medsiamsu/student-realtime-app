<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üìä ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° Realtime</title>

<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{font-family:'Sarabun',sans-serif;background:#e0e7ff;margin:0;display:flex;justify-content:center}
.container{background:#fff;margin:20px;padding:20px;border-radius:16px;width:100%;max-width:950px;text-align:center}
.hidden{display:none}
button{padding:10px 18px;border-radius:8px;border:0;color:#fff;margin:5px;cursor:pointer}
.btn-primary{background:#2563eb}.btn-green{background:#10b981}.btn-purple{background:#8b5cf6}.btn-red{background:#ef4444}
input,select{padding:10px;border-radius:8px;border:1px solid #ccc;width:220px;margin-bottom:8px}
.choices button{width:55px;height:55px;border-radius:50%;background:#f1f5f9;color:#000;border:2px solid #cbd5e1}
.choices button.selected{background:#2563eb;color:#fff}
.responses-list{margin-top:10px;border:1px solid #ddd;border-radius:10px;max-height:300px;overflow:auto;text-align:left}
.response-item{display:flex;justify-content:space-between;padding:6px 10px;border-bottom:1px solid #eee}
.chart-box{margin-top:25px;padding:15px;border:1px solid #e5e7eb;border-radius:12px}
</style>
</head>

<body>
<div class="container">

<!-- HOME -->
<div id="homePage">
  <h1>üìò ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° Realtime</h1>
  <h3>‡∏£‡∏≠‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span id="currentRoundLabel"></span></h3>
  <button class="btn-green" id="toStudent">üéì ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</button>
  <button class="btn-purple" id="toTeacher">üë©‚Äçüè´ ‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå</button>
</div>

<!-- STUDENT -->
<div id="studentPage" class="hidden">
  <h2>üéì ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h2>
  <p>‡∏£‡∏≠‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <b id="roundStudent"></b></p>
  <input id="room" placeholder="‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"><br>
  <input id="student_id" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤"><br>
  <div class="choices">
    <button data-c="A">A</button><button data-c="B">B</button>
    <button data-c="C">C</button><button data-c="D">D</button>
    <button data-c="E">E</button>
  </div><br>
  <button class="btn-green" id="submitBtn">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
  <button class="btn-primary" id="backHome1">üè† ‡∏Å‡∏•‡∏±‡∏ö</button>
  <div id="status"></div>
</div>

<!-- TEACHER -->
<div id="teacherPage" class="hidden">
  <h2>üë©‚Äçüè´ ‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå</h2>
  <p>‡∏£‡∏≠‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <b id="roundTeacher"></b></p>
  <button class="btn-green" id="newRoundBtn">‚ûï ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà</button>
  <button class="btn-red" id="resetAllBtn">‚ôªÔ∏è ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
  <button class="btn-primary" id="exportExcelBtn">üì• Export Excel</button>
  <br><br>
  <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡∏π‡∏£‡∏≠‡∏ö:</label>
  <select id="roundFilter"><option value="all">‡∏ó‡∏∏‡∏Å‡∏£‡∏≠‡∏ö</option></select>
  <div id="chartsContainer"></div>
  <div id="responsesList" class="responses-list"></div>
  <button class="btn-primary" id="backHome2">üè† ‡∏Å‡∏•‡∏±‡∏ö</button>
</div>

</div>

<script>
document.addEventListener("DOMContentLoaded",()=>{

const $=id=>document.getElementById(id);

// DOM
const homePage=$("homePage"),studentPage=$("studentPage"),teacherPage=$("teacherPage");
const toStudent=$("toStudent"),toTeacher=$("toTeacher");
const backHome1=$("backHome1"),backHome2=$("backHome2");
const submitBtn=$("submitBtn"),newRoundBtn=$("newRoundBtn"),
      resetAllBtn=$("resetAllBtn"),exportExcelBtn=$("exportExcelBtn");
const room=$("room"),student_id=$("student_id"),status=$("status");
const currentRoundLabel=$("currentRoundLabel"),
      roundStudent=$("roundStudent"),roundTeacher=$("roundTeacher");
const chartsContainer=$("chartsContainer"),
      responsesList=$("responsesList"),roundFilter=$("roundFilter");

// Supabase
const supabase=window.supabase.createClient(
"https://dmubpvmqslemshqlbcsy.supabase.co",
"YOUR_ANON_KEY"
);

// State
let currentRound=1,roundOpen=true,selected=null;
let isResetting=false;
const chartsByRound={},roundCounts={};

// Navigation
toStudent.onclick=()=>{homePage.classList.add("hidden");studentPage.classList.remove("hidden")};
toTeacher.onclick=()=>{
  if(prompt("‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå")==="2568"){
    homePage.classList.add("hidden");
    teacherPage.classList.remove("hidden");
    initialLoad();
  }
};
backHome1.onclick=backHome2.onclick=()=>location.reload();

// Choice
document.querySelectorAll(".choices button").forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll(".choices button").forEach(x=>x.classList.remove("selected"));
    b.classList.add("selected");
    selected=b.dataset.c;
  };
});

// Sync round
async function syncRound(){
  const {data}=await supabase.from("round_control").select("*").eq("id",1).single();
  currentRound=data.current_round;
  roundOpen=data.is_open;
  currentRoundLabel.innerText=roundStudent.innerText=roundTeacher.innerText=currentRound;
  submitBtn.disabled=!roundOpen;
}
syncRound();

// Student submit (üî• ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á)
submitBtn.onclick=async()=>{
  await syncRound();
  if(!roundOpen){alert("‚ùå ‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß");return;}
  if(!room.value||!student_id.value||!selected){alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");return;}

  submitBtn.disabled=true;
  status.innerText="‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...";

  const {data:ex}=await supabase.from("attendance")
    .select("id")
    .eq("student_id",student_id.value)
    .eq("round_id",currentRound)
    .maybeSingle();

  if(ex){
    status.innerText="‚ö†Ô∏è ‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß";
    submitBtn.disabled=false;
    return;
  }

  await supabase.from("attendance").insert({
    room:room.value,
    student_id:student_id.value,
    round_id:currentRound,
    question_number:1,
    choice:selected
  });

  status.innerText="‚úÖ ‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß";
};

// Reset UI
function hardResetTeacherUI(){
  Object.values(chartsByRound).forEach(c=>c.destroy());
  Object.keys(chartsByRound).forEach(k=>delete chartsByRound[k]);
  Object.keys(roundCounts).forEach(k=>delete roundCounts[k]);
  chartsContainer.innerHTML="";
  responsesList.innerHTML="";
  roundFilter.innerHTML=`<option value="all">‡∏ó‡∏∏‡∏Å‡∏£‡∏≠‡∏ö</option>`;
}

// Load data
async function initialLoad(){
  hardResetTeacherUI();
  const {data}=await supabase.from("attendance").select("*").order("round_id");
  data.forEach(r=>{
    if(!roundCounts[r.round_id]){
      roundCounts[r.round_id]={A:0,B:0,C:0,D:0,E:0};
      roundFilter.innerHTML+=`<option value="${r.round_id}">‡∏£‡∏≠‡∏ö ${r.round_id}</option>`;
    }
    roundCounts[r.round_id][r.choice]++;
    responsesList.innerHTML+=`
      <div class="response-item">
        <span>${r.student_id} (${r.room})</span>
        <b>${r.choice}</b>
        <span>‡∏£‡∏≠‡∏ö ${r.round_id}</span>
      </div>`;
  });
  Object.keys(roundCounts).forEach(r=>renderChart(r,roundCounts[r]));
}

// Chart
function renderChart(round,counts){
  const box=document.createElement("div");
  box.className="chart-box";
  box.dataset.round=round;
  box.innerHTML=`<h4>‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà ${round}</h4>`;
  const c=document.createElement("canvas");
  box.appendChild(c);
  chartsContainer.appendChild(box);

  chartsByRound[round]=new Chart(c,{
    type:"pie",
    data:{labels:Object.keys(counts),datasets:[{data:Object.values(counts)}]}
  });
}

// Filter
roundFilter.onchange=()=>{
  document.querySelectorAll(".chart-box").forEach(b=>{
    b.style.display=(roundFilter.value==="all"||b.dataset.round===roundFilter.value)?"block":"none";
  });
};

// New round (üî• sync ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)
newRoundBtn.onclick=async()=>{
  await supabase.from("round_control")
    .update({current_round:currentRound+1,is_open:true})
    .eq("id",1);
  await syncRound();
};

// Reset
resetAllBtn.onclick=async()=>{
  if(!confirm("‚ö†Ô∏è ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?"))return;
  isResetting=true;
  hardResetTeacherUI();
  await supabase.rpc("truncate_attendance");
  await supabase.from("round_control")
    .update({current_round:1,is_open:true})
    .eq("id",1);
};

// Export
exportExcelBtn.onclick=async()=>{
  const {data}=await supabase.from("attendance").select("*");
  const wb=XLSX.utils.book_new(),g={};
  data.forEach(r=>{if(!g[r.round_id])g[r.round_id]=[];g[r.round_id].push(r)});
  Object.keys(g).forEach(r=>{
    XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(g[r]),"Round_"+r);
  });
  XLSX.writeFile(wb,"attendance.xlsx");
};

// Realtime: ‡∏£‡∏≠‡∏ö
supabase.channel("round-rt")
.on("postgres_changes",{event:"UPDATE",schema:"public",table:"round_control"},()=>{
  syncRound();
  if(!isResetting && !teacherPage.classList.contains("hidden")){
    initialLoad();
  }
  isResetting=false;
})
.subscribe();

// Realtime: attendance (üî• ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)
supabase.channel("attendance-rt")
.on("postgres_changes",{event:"*",schema:"public",table:"attendance"},()=>{
  if(!teacherPage.classList.contains("hidden")){
    initialLoad();
  }
})
.subscribe();

});
</script>
</body>
</html>
