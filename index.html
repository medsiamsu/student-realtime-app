<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“Š à¸£à¸°à¸šà¸šà¸•à¸­à¸šà¸„à¸³à¸–à¸²à¸¡ Realtime (à¸„à¸£à¸šà¸—à¸¸à¸à¸£à¸­à¸š)</title>

<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{font-family:'Sarabun',sans-serif;background:#e0e7ff;margin:0;display:flex;justify-content:center}
.container{background:#fff;margin:20px;padding:20px;border-radius:16px;width:100%;max-width:900px;text-align:center}
.hidden{display:none}
button{padding:10px 18px;border-radius:8px;border:0;color:#fff;margin:5px;cursor:pointer}
.btn-primary{background:#2563eb}
.btn-green{background:#10b981}
.btn-purple{background:#8b5cf6}
.btn-red{background:#ef4444}
input{padding:10px;border-radius:8px;border:1px solid #ccc;width:200px}
.choices button{width:55px;height:55px;border-radius:50%;background:#f1f5f9;color:#000;border:2px solid #cbd5e1}
.choices button.selected{background:#2563eb;color:#fff}
.responses-list{margin-top:10px;border:1px solid #ddd;border-radius:10px;max-height:300px;overflow:auto}
.response-item{display:flex;justify-content:space-between;padding:6px 10px;border-bottom:1px solid #eee}
canvas{max-width:100%;margin-top:25px}
</style>
</head>
<body>

<div class="container">

<!-- HOME -->
<div id="homePage">
  <h1>ğŸ“˜ à¸£à¸°à¸šà¸šà¸•à¸­à¸šà¸„à¸³à¸–à¸²à¸¡ Realtime (à¸„à¸£à¸šà¸—à¸¸à¸à¸£à¸­à¸š)</h1>
  <h3>à¸£à¸­à¸šà¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™: <span id="currentRoundLabel"></span></h3>
  <button class="btn-green" id="toStudent">ğŸ“ à¸™à¸±à¸à¸¨à¸¶à¸à¸©à¸²</button>
  <button class="btn-purple" id="toTeacher">ğŸ‘©â€ğŸ« à¸­à¸²à¸ˆà¸²à¸£à¸¢à¹Œ</button>
</div>

<!-- STUDENT -->
<div id="studentPage" class="hidden">
  <h2>ğŸ“ à¸™à¸±à¸à¸¨à¸¶à¸à¸©à¸²</h2>
  <p>à¸£à¸­à¸šà¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™: <b id="roundStudent"></b></p>

  <input id="room" placeholder="à¸«à¹‰à¸­à¸‡à¹€à¸£à¸µà¸¢à¸™"><br><br>
  <input id="student_id" placeholder="à¸£à¸«à¸±à¸ªà¸™à¸±à¸à¸¨à¸¶à¸à¸©à¸²"><br><br>

  <div class="choices">
    <button data-c="A">A</button>
    <button data-c="B">B</button>
    <button data-c="C">C</button>
    <button data-c="D">D</button>
    <button data-c="E">E</button>
  </div><br>

  <button class="btn-green" id="submitBtn">à¸ªà¹ˆà¸‡à¸„à¸³à¸•à¸­à¸š</button>
  <button class="btn-primary" id="backHome1">ğŸ  à¸à¸¥à¸±à¸š</button>
  <p id="status"></p>
</div>

<!-- TEACHER -->
<div id="teacherPage" class="hidden">
  <h2>ğŸ‘©â€ğŸ« à¸­à¸²à¸ˆà¸²à¸£à¸¢à¹Œ</h2>
  <p>à¸£à¸­à¸šà¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™: <b id="roundTeacher"></b></p>

  <button class="btn-red" id="newRoundBtn">â• à¹€à¸£à¸´à¹ˆà¸¡à¸£à¸­à¸šà¹ƒà¸«à¸¡à¹ˆ</button>
  <button class="btn-green" id="exportExcelBtn">Export Excel</button>

  <canvas id="pieChart"></canvas>
  <div id="responsesList" class="responses-list"></div>

  <button class="btn-primary" id="backHome2">ğŸ  à¸à¸¥à¸±à¸š</button>
</div>

</div>

<script>
// ================= Supabase =================
const SUPABASE_URL = "https://ebqmunvfantlffbqvybx.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVicW11bnZmYW50bGZmYnF2eWJ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MTU5NTcsImV4cCI6MjA3ODQ5MTk1N30.wg4AkJTrhCYqwM9YbG8SvAuB7HNOpNmbYJTU_2RBASo";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ================= Variables =================
let currentRound = 1;
let selected = null;
let pieChart;

// ================= Sync Round =================
async function syncRound(){
  const { data } = await supabase.from("round_control").select("current_round").eq("id",1).single();
  if(data) currentRound = data.current_round || 1;
  updateRoundUI();
}
syncRound();

// Realtime round update
supabase.channel("round")
  .on("postgres_changes",{event:"UPDATE",schema:"public",table:"round_control"},payload=>{
    currentRound = payload.new.current_round;
    updateRoundUI();
    loadAll();
  }).subscribe();

function updateRoundUI(){
  currentRoundLabel.innerText = currentRound;
  roundStudent.innerText = currentRound;
  roundTeacher.innerText = currentRound;
}

// ================= NAVIGATION =================
toStudent.onclick = ()=>{ homePage.classList.add("hidden"); studentPage.classList.remove("hidden"); }
toTeacher.onclick = ()=>{
  if(prompt("à¸£à¸«à¸±à¸ªà¸­à¸²à¸ˆà¸²à¸£à¸¢à¹Œ") === "2568"){
    homePage.classList.add("hidden"); teacherPage.classList.remove("hidden"); loadAll();
  }
}
backHome1.onclick = ()=>{ studentPage.classList.add("hidden"); homePage.classList.remove("hidden"); }
backHome2.onclick = ()=>{ teacherPage.classList.add("hidden"); homePage.classList.remove("hidden"); }

// ================= CHOICES =================
document.querySelectorAll(".choices button").forEach(b=>{
  b.onclick = ()=>{
    document.querySelectorAll(".choices button").forEach(x=>x.classList.remove("selected"));
    b.classList.add("selected");
    selected = b.dataset.c;
  }
});

// ================= SUBMIT =================
submitBtn.onclick = async ()=>{
  const roomEl = document.getElementById("room");
  const studentEl = document.getElementById("student_id");
  const statusEl = document.getElementById("status");

  const room = roomEl.value.trim();
  const student_id = studentEl.value.trim();
  if(!room || !student_id || !selected) return alert("à¸à¸£à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸«à¹‰à¸„à¸£à¸š");

  // âœ… à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹à¸¥à¸°à¸ªà¸£à¹‰à¸²à¸‡à¸£à¸­à¸šà¹ƒà¸™ round_control à¸à¹ˆà¸­à¸™
  await supabase.from("round_control").upsert({id: currentRound, current_round: currentRound, updated_at: new Date()});

  // âœ… à¸à¸±à¸™à¸ªà¹ˆà¸‡à¸‹à¹‰à¸³à¸•à¹ˆà¸­à¸£à¸­à¸š
  const { data: dup } = await supabase
    .from("attendance")
    .select("id")
    .eq("student_id", student_id)
    .eq("round_id", currentRound)
    .maybeSingle();

  if(dup){
    statusEl.innerText = "âš ï¸ à¸„à¸¸à¸“à¸ªà¹ˆà¸‡à¸£à¸­à¸šà¸™à¸µà¹‰à¹à¸¥à¹‰à¸§";
    return;
  }

  // Insert attendance
  const { error } = await supabase.from("attendance").insert([{
    room, student_id, choice: selected, round_id: currentRound, question_number:1, answered_at: new Date()
  }]);

  if(error){
    alert("âŒ à¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ: "+error.message);
    return;
  }
  statusEl.innerText = "âœ… à¸ªà¹ˆà¸‡à¸„à¸³à¸•à¸­à¸šà¹à¸¥à¹‰à¸§";
}

// ================= Realtime Attendance =================
supabase.channel("attendance")
  .on("postgres_changes",{event:"INSERT",schema:"public",table:"attendance"},()=>loadAll())
  .subscribe();

// ================= Load Data =================
async function loadAll(){
  const { data } = await supabase
    .from("attendance")
    .select("*")
    .order("answered_at",{ascending:true});

  responsesList.innerHTML = data.map(r=>`
    <div class="response-item">
      <span>${r.student_id} (${r.room})</span>
      <b>${r.choice}</b>
      <span>à¸£à¸­à¸š: ${r.round_id}</span>
    </div>`).join("");

  const counts={A:0,B:0,C:0,D:0,E:0};
  data.forEach(r=> counts[r.choice]++);

  pieChart?.destroy();
  pieChart = new Chart(document.getElementById("pieChart"),{
    type:"pie",
    data:{labels:Object.keys(counts),datasets:[{data:Object.values(counts)}]}
  });
}

// ================= EXPORT =================
exportExcelBtn.onclick = async ()=>{
  const { data } = await supabase.from("attendance").select("*");
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(data),`ALL_ROUNDS`);
  XLSX.writeFile(wb, `attendance_all_rounds.xlsx`);
}

// ================= NEW ROUND =================
newRoundBtn.onclick = async ()=>{
  currentRound++;
  // à¸ªà¸£à¹‰à¸²à¸‡à¸£à¸­à¸šà¹ƒà¸«à¸¡à¹ˆà¹ƒà¸™ round_control à¹€à¸à¸·à¹ˆà¸­à¹ƒà¸«à¹‰ FK à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡
  await supabase.from("round_control").upsert({id: currentRound, current_round: currentRound, updated_at: new Date()});
  alert("âœ… à¹€à¸£à¸´à¹ˆà¸¡à¸£à¸­à¸šà¹ƒà¸«à¸¡à¹ˆà¹à¸¥à¹‰à¸§: "+currentRound);
}
</script>
</body>
</html>
