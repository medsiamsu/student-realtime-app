<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“Š à¸£à¸°à¸šà¸šà¸•à¸­à¸šà¸„à¸³à¸–à¸²à¸¡ Realtime</title>

<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{font-family:'Sarabun',sans-serif;background:#e0e7ff;margin:0;display:flex;justify-content:center}
.container{background:#fff;margin:20px;padding:20px;border-radius:16px;width:100%;max-width:950px;text-align:center}
.hidden{display:none}
button{padding:10px 18px;border-radius:8px;border:0;color:#fff;margin:5px;cursor:pointer}
.btn-primary{background:#2563eb}.btn-green{background:#10b981}.btn-purple{background:#8b5cf6}.btn-red{background:#ef4444}
input,select{padding:10px;border-radius:8px;border:1px solid #ccc;width:220px;margin-bottom:8px}
.choices button{width:55px;height:55px;border-radius:50%;background:#f1f5f9;color:#000;border:2px solid #cbd5e1}
.choices button.selected{background:#2563eb;color:#fff}
.responses-list{margin-top:10px;border:1px solid #ddd;border-radius:10px;max-height:300px;overflow:auto;text-align:left}
.chart-box{margin-top:25px;padding:15px;border:1px solid #e5e7eb;border-radius:12px}
</style>
</head>

<body>
<div class="container">

<!-- HOME -->
<div id="homePage">
  <h1>ğŸ“˜ à¸£à¸°à¸šà¸šà¸•à¸­à¸šà¸„à¸³à¸–à¸²à¸¡ Realtime</h1>
  <h3>à¸£à¸­à¸šà¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™: <span id="currentRoundLabel"></span></h3>
  <button class="btn-green" id="toStudent">ğŸ“ à¸™à¸±à¸à¸¨à¸¶à¸à¸©à¸²</button>
  <button class="btn-purple" id="toTeacher">ğŸ‘©â€ğŸ« à¸­à¸²à¸ˆà¸²à¸£à¸¢à¹Œ</button>
</div>

<!-- STUDENT -->
<div id="studentPage" class="hidden">
  <h2>ğŸ“ à¸™à¸±à¸à¸¨à¸¶à¸à¸©à¸²</h2>
  <p>à¸£à¸­à¸šà¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™: <b id="roundStudent"></b></p>
  <input id="room" placeholder="à¸«à¹‰à¸­à¸‡à¹€à¸£à¸µà¸¢à¸™"><br>
  <input id="student_id" placeholder="à¸£à¸«à¸±à¸ªà¸™à¸±à¸à¸¨à¸¶à¸à¸©à¸²"><br>
  <div class="choices">
    <button data-c="A">A</button>
    <button data-c="B">B</button>
    <button data-c="C">C</button>
    <button data-c="D">D</button>
    <button data-c="E">E</button>
  </div><br>
  <button class="btn-green" id="submitBtn">à¸ªà¹ˆà¸‡à¸„à¸³à¸•à¸­à¸š</button>
  <button class="btn-primary" id="backHome1">ğŸ  à¸à¸¥à¸±à¸š</button>
  <div id="status"></div>
</div>

<!-- TEACHER -->
<div id="teacherPage" class="hidden">
  <h2>ğŸ‘©â€ğŸ« à¸­à¸²à¸ˆà¸²à¸£à¸¢à¹Œ</h2>
  <p>à¸£à¸­à¸šà¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™: <b id="roundTeacher"></b></p>
  <button class="btn-green" id="newRoundBtn">â• à¹€à¸£à¸´à¹ˆà¸¡à¸£à¸­à¸šà¹ƒà¸«à¸¡à¹ˆ</button>
  <button class="btn-red" id="resetAllBtn">ğŸ§¹ à¸¥à¹‰à¸²à¸‡à¸«à¸™à¹‰à¸²à¸£à¸°à¸šà¸š</button>
  <button class="btn-primary" id="exportExcelBtn">ğŸ“¥ Export Excel</button>
  <br><br>
  <label>à¹€à¸¥à¸·à¸­à¸à¸”à¸¹à¸£à¸­à¸š:</label>
  <select id="roundFilter">
    <option value="all">à¸—à¸¸à¸à¸£à¸­à¸š</option>
  </select>
  <div id="chartsContainer"></div>
  <button class="btn-primary" id="backHome2">ğŸ  à¸à¸¥à¸±à¸š</button>
</div>

</div>

<script>
document.addEventListener("DOMContentLoaded",()=>{
const SYSTEM_RESET_KEY = "SYSTEM_RESET_DONE";
const $=id=>document.getElementById(id);

// DOM
const homePage=$("homePage"),studentPage=$("studentPage"),teacherPage=$("teacherPage");
const toStudent=$("toStudent"),toTeacher=$("toTeacher");
const backHome1=$("backHome1"),backHome2=$("backHome2");
const submitBtn=$("submitBtn"),newRoundBtn=$("newRoundBtn"),
      resetAllBtn=$("resetAllBtn"),exportExcelBtn=$("exportExcelBtn");
const room=$("room"),student_id=$("student_id"),status=$("status");
const currentRoundLabel=$("currentRoundLabel"),
      roundStudent=$("roundStudent"),roundTeacher=$("roundTeacher");
const chartsContainer=$("chartsContainer"),roundFilter=$("roundFilter");

// Supabase
const supabase=window.supabase.createClient(
  "https://nbhxeojflxxmowiaogjh.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5iaHhlb2pmbHh4bW93aWFvZ2poIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4MzQ0ODAsImV4cCI6MjA4MzQxMDQ4MH0.eOX4LtcSzetMbOFTKaH8ElWJx0l8V2SLFgeb0a3IVWw"
);

// State
let currentRound=1,roundOpen=true,selected=null;
let chartsByRound={},roundCounts={};
let roundChannel=null,attendanceChannel=null;
let realtimeActive=false;
let systemResetMode = false;

// ---------- Realtime ----------
function subscribeRealtime(){
  if(realtimeActive || systemResetMode) return;

  realtimeActive = true;

  roundChannel = supabase.channel("round-rt")
    .on("postgres_changes",{event:"UPDATE",schema:"public",table:"round_control"}, syncRound)
    .subscribe();

  attendanceChannel = supabase.channel("attendance-rt")
    .on("postgres_changes",{event:"*",schema:"public",table:"attendance"}, initialLoad)
    .subscribe();
}


function unsubscribeRealtime(){
  if(roundChannel) supabase.removeChannel(roundChannel);
  if(attendanceChannel) supabase.removeChannel(attendanceChannel);
  realtimeActive=false;
}

// ---------- Navigation ----------
toStudent.onclick=async()=>{
  homePage.classList.add("hidden");
  studentPage.classList.remove("hidden");
  subscribeRealtime();
  await syncRound();
};

toTeacher.onclick=async()=>{
  if(prompt("à¸£à¸«à¸±à¸ªà¸­à¸²à¸ˆà¸²à¸£à¸¢à¹Œ")==="2568"){
    homePage.classList.add("hidden");
    teacherPage.classList.remove("hidden");
    subscribeRealtime();
    await syncRound();
  }
};


backHome1.onclick=backHome2.onclick=()=>location.reload();

// ---------- Choice ----------
document.querySelectorAll(".choices button").forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll(".choices button").forEach(x=>x.classList.remove("selected"));
    b.classList.add("selected");
    selected=b.dataset.c;
  };
});

// ---------- Round ----------
async function syncRound(){
  const {data}=await supabase.from("round_control").select("*").eq("id",1).single();
  if(!data) return;
  currentRound=data.current_round;
  roundOpen=data.is_open;
  currentRoundLabel.innerText=roundStudent.innerText=roundTeacher.innerText=currentRound;
  submitBtn.disabled = false; // à¹„à¸¡à¹ˆ disable à¸›à¸¸à¹ˆà¸¡
}
syncRound();

// ---------- Student ----------
submitBtn.onclick=async()=>{
  await syncRound();
  if(!roundOpen){alert("âŒ à¸£à¸­à¸šà¸›à¸´à¸”à¹à¸¥à¹‰à¸§");return;}
  if(!room.value||!student_id.value||!selected){alert("à¸à¸£à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸«à¹‰à¸„à¸£à¸š");return;}

  const {data:ex}=await supabase
    .from("attendance")
    .select("id")
    .eq("student_id",student_id.value)
    .eq("round_id",currentRound)
    .maybeSingle();

  if(ex){status.innerText="âš ï¸ à¸ªà¹ˆà¸‡à¹à¸¥à¹‰à¸§";return;}

  const {error}=await supabase.from("attendance").insert({
    room:room.value,
    student_id:student_id.value,
    round_id:currentRound,
    question_number:1,
    choice:selected
  });

  if(error){
    status.innerText="âŒ à¸ªà¹ˆà¸‡à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ";
    alert(error.message);
    return;
  }

  status.innerText="âœ… à¸ªà¹ˆà¸‡à¹à¸¥à¹‰à¸§";
};

// ---------- Teacher UI ----------
function hardResetTeacherUI(){
  Object.values(chartsByRound).forEach(c=>c.destroy());
  chartsByRound={};roundCounts={};
  chartsContainer.innerHTML="";
  roundFilter.innerHTML=`<option value="all">à¸—à¸¸à¸à¸£à¸­à¸š</option>`;
}

async function initialLoad(){

  // ğŸ”¥ BLOCK 100%
  if (systemResetMode || sessionStorage.getItem(SYSTEM_RESET_KEY) === "true") {
    console.log("BLOCK initialLoad");
    return;
  }

  hardResetTeacherUI();

  const {data}=await supabase
    .from("attendance")
    .select("*")
    .order("round_id");

  if(!data) return;

  data.forEach(r=>{
    if(!roundCounts[r.round_id]){
      roundCounts[r.round_id]={A:0,B:0,C:0,D:0,E:0};
      roundFilter.innerHTML+=`<option value="${r.round_id}">à¸£à¸­à¸š ${r.round_id}</option>`;
    }
    roundCounts[r.round_id][r.choice]++;
  });

  Object.keys(roundCounts).forEach(r =>
    renderChart(r, roundCounts[r])
  );
}

function renderChart(round,counts){
  const box=document.createElement("div");
  box.className="chart-box";
  box.innerHTML=`<h4>à¸£à¸­à¸šà¸—à¸µà¹ˆ ${round}</h4>`;
  const c=document.createElement("canvas");
  box.appendChild(c);
  chartsContainer.appendChild(box);

  chartsByRound[round]=new Chart(c,{
    type:"pie",
    data:{labels:Object.keys(counts),datasets:[{data:Object.values(counts)}]}
  });
}

// ---------- Buttons ----------
newRoundBtn.onclick=async()=>{
  await supabase.from("round_control")
    .update({current_round:currentRound+1,is_open:true})
    .eq("id",1);
  syncRound();
};

resetAllBtn.onclick = async () => {
  if (!confirm("à¸¥à¹‰à¸²à¸‡à¸£à¸°à¸šà¸šà¸—à¸±à¹‰à¸‡à¸«à¸™à¹‰à¸²à¹€à¸§à¹‡à¸š (à¹„à¸¡à¹ˆà¸¥à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸™à¸à¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥) ?")) return;

  // ğŸ”’ à¸•à¸±à¸”à¹„à¸Ÿà¸—à¸±à¹‰à¸‡à¸£à¸°à¸šà¸š
  systemResetMode = true;

  unsubscribeRealtime();

  sessionStorage.setItem(SYSTEM_RESET_KEY, "true");

  await supabase
    .from("round_control")
    .update({ current_round: 1, is_open: true })
    .eq("id", 1);

  hardResetTeacherUI();
  chartsByRound = {};
  roundCounts = {};
  chartsContainer.innerHTML = "";

  await syncRound();

  alert("âœ… à¸¥à¹‰à¸²à¸‡à¸£à¸°à¸šà¸šà¹à¸¥à¹‰à¸§ (à¸à¸£à¸²à¸Ÿà¸ˆà¸°à¹„à¸¡à¹ˆà¹€à¸”à¹‰à¸‡à¸­à¸µà¸)");
};


exportExcelBtn.onclick=async()=>{
  const {data}=await supabase.from("attendance").select("*");
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(data),"data");
  XLSX.writeFile(wb,"attendance.xlsx");
};
window.addEventListener("beforeunload", () => {
  sessionStorage.removeItem(SYSTEM_RESET_KEY);
});

});
</script>
</body>
</html>
